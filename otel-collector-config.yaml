# OpenTelemetry Collector Configuration
# Receives traces via OTLP and exports to ClickHouse

receivers:
  # OTLP receiver - accepts traces from your Go application
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317  # gRPC endpoint
      http:
        endpoint: 0.0.0.0:4318  # HTTP endpoint

  # Filelog receiver - reads logs from app.log file
  filelog:
    include:
      - /var/log/app/app.log
    start_at: end
    operators:
      # Parse JSON logs
      - type: json_parser
        timestamp:
          parse_from: attributes.timestamp
          layout: '%Y-%m-%dT%H:%M:%S.%L%z'

processors:
  # Batch processor - batches telemetry data before export
  batch:
    timeout: 1s
    send_batch_size: 1024

exporters:
  # ClickHouse exporter - stores traces in ClickHouse database
  clickhouse:
    endpoint: tcp://host.docker.internal:9000?dial_timeout=10s&compress=lz4
    username: default
    password: clickhouse
    database: otel
    ttl: 72h
    traces_table_name: otel_traces
    logs_table_name: otel_logs
    metrics_table_name: otel_metrics
    timeout: 5s
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

  # Debug exporter - prints to console for debugging (optional)
  debug:
    verbosity: detailed

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [clickhouse, debug]
    logs:
      receivers: [filelog]
      processors: [batch]
      exporters: [clickhouse, debug]
